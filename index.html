<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://niviz.org/lib/niviz-bundle-latest.js"></script>
  
<style>
  body {
    font-family: sans-serif;
    margin: 12px;
  }

  #plots {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 24px;
    flex-wrap: nowrap;
  }

  /* Main seasonal timeline */
  #timeline {
    width: 65vw;
    height: 75vh;
    min-width: 600px;
  }

  /* Point profile */
  #profile {
    width: 30vw;
    height: 75vh;
    min-width: 380px;
  }

  /* SMET timeline */
  #smet_timeline {
    width: 95vw;
    height: 35vh;
    min-height: 260px;
    margin-top: 12px;
  }

  svg {
    border: 1px solid #ccc;
  }
</style>
</head>

<script>
var timelinegraph = null;
var profilegraph  = null;
var smetgraph     = null;

function draw () {

  /* ---- PRO FILE (SNOWPACK STATE) ---- */
  $.ajax({
    url: "data/YESA2.pro",
    success: function (response){
      niviz.parse(response, 'pro', function (error, station) {
        if (error) {
          alert('NiViz PRO parse error');
        } else {
          niviz.Common.defaults.language = 'english';

          timelinegraph = niviz.draw(
            'Timeline',
            station,
            $('#timeline'),
            {}
          );

          profilegraph = niviz.draw(
            'SimpleProfile',
            station,
            $('#profile'),
            { miniature: true }
          );

          station.emitter.on('profile', update);
        }
      });
    }
  });

  /* ---- SMET FILE (FORCING) ---- */
  $.ajax({
    url: "data/YESA2.smet",
    dataType: "text",
    success: function (response) {
      niviz.parse(response, 'smet', function (error, station) {
        if (error) {
          console.error('NiViz SMET parse error', error);
        } else {
          smetgraph = niviz.draw(
            'Timeline',
            station,
            $('#smet_timeline'),
            {}
          );
        }
      });
    },
    error: function () {
      console.error("Failed to load SMET file");
    }
  });
}

function update (profile) {
  document.getElementById('currentdate').innerText =
    profile.date.format('DD MMM YYYY HH:mm');
}

function parameter (p) {
  if (!timelinegraph) return;
  timelinegraph.setProperties({ parameter: p });
  timelinegraph.draw();
}

function smetParameter (p) {
  if (!smetgraph) return;
  smetgraph.setProperties({ parameter: p });
  smetgraph.draw();
}
</script>

<body onload="draw()">

<h2>SNOWPACK â€“ NiViz Visualization</h2>

<div id="plots">
  <svg id="timeline"></svg>
  <svg id="profile"></svg>
</div>

<div id="currentdate">
  Hover over the timeline graph
</div>

<br>

<!-- PRO controls -->
<button onclick="parameter('temperature')">Temperature</button>
<button onclick="parameter('density')">Density</button>
<button onclick="parameter('grainshape')">Grain Shape</button>
<button onclick="parameter('grainsize')">Grain Size</button>
<button onclick="parameter('wetness')">Wetness</button>

<hr>

<h3>Meteorological Data (SMET)</h3>

<svg id="smet_timeline" width="1200" height="300"></svg>

<br>

<!-- SMET controls -->
<button onclick="smetParameter('TA')">Air Temp</button>

</body>
</html>


